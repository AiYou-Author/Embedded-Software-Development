# 计算机



### 计算机组成

![image-20220727203830835](https://s2.loli.net/2022/07/27/RA657IWD32jkPLY.png)

- 输入设备
  - 将其他信号转换成计算机能识别和处理的信号传入计算机
- 输出设备
  - 把运算结果传出计算机外
- 存储器
  - 存储程序和数据的部件
- 运算器
  - CPU中负责进行算术运算和逻辑运算的部件
- 控制器
  - 控制器是CPU的指挥中心，控制CPU执行程序的逻辑过程



### 总线

- 总线

  总线是计算机各个部件之间传送信息的公共通信干线。按照信息的类型分为**数据总线，地址总线，控制总线**。

- DMA总线

  DMA（Direct Memory Access）直接存储访问，使用DMA总线可以不通过CPU直接在存储器之间进行数据传递

![image-20220727204345986](https://s2.loli.net/2022/07/27/8D4oflH9dVItnpb.png)





### 三级存储结构

- 高速缓存

  速度快，断电数据丢失，CPU可直接访问。存储当前正在执行的程序中的活跃部分，以便快速的向CPU提供指令和数据

- 内存

  断电数据丢失，CPU直接访问存储当前正在执行的程序和数据

- 硬盘

  CPU不直接访问，存储暂时不运行的程序和数据，需要时再传送到主存



### 地址空间

​	一个处理器能够访问（读写）的存储空间是有限的,我们称这个空间为它的地址空间（寻址空间）,一般来说N位地址总线的处理器的地址空间是2的N次方



### CPU工作原理

1.   取址：

   CPU将**PC寄存器**中的地址发送给内存，内存将其地址中对应的指令返回 到CPU中的**指令寄存器（IR）**

2.   译码：

   译码器对**IR中的指令进行识别**，将指令（机器码）解析成具体的运算

3.   执行：

   控制器控制运算器中对应的运算单元进行运算，运算结果写入寄存器

![image-20220727210443194](https://s2.loli.net/2022/07/27/V2LHgBMtAWIKlbO.png)

每执行一条指令后PC的值会自动增加指向下一条指令















# ARM基本介绍

- 早先经典处理器包括ARM7、ARM9、ARM11家族。

- Cortex-M系列

  为单片机驱动的系统提供的低成本优化方案，应用于传统的微控制器市场，智能传感器，汽车周边部件等。

- Cortex-A系列

  针对开放式操作系统的高性能处理器；

  应用于智能手机，数字电视，智能本等高端运用。

- Cortex-R系列

  针对实时系统、满足实时性的控制需求；

  应于汽车制动系统，动力系统等。

![image-20220725144442543](https://s2.loli.net/2022/07/25/5JgbLSlnZD7HoOc.png)



### ARM处理器架构

体系结构定义**指令集**和基于这一体系结构下处理器的**编程模型**（基本数据类型，工作模型，寄存器组）



**ARM体系结构发展**

目前ARM体系架构共定义了8个版本V1-V8

V1-V3最早的版本,目前已废弃

V4-V6经典处理器中运用的比较多

V7 目前Cortex系列处理器主要是这种架构、支持Thumb-2的32位指令集

V8兼容ARMv7架构的特性,开支持64位数据处理

![image-20220725145738514](https://s2.loli.net/2022/07/25/tUqOKyQ4hc7Gfmo.png)





### ARM指令集



#### **指令集的概念**

- 处理器能够识别并执行的指令集合;
- 每一条指令可处理一个简单或复杂操作(加、加乘.);
- 每一条指令对应一条或几条汇编指令。



#### **指令集常见分类**

**复杂指令集(CISC)** :包含处理复杂操作的特定指令,硬件结构复杂，指令长度不固定，执行需要多个周期。x86

**精简指令集(RISC):**只保留常用的简单指令，硬件结构简单，复杂操作一般通过简单指令的组合实现，指令简单而有效，格式和长度通常是固定的，大多数指令在一个周期内可以执行完毕。ARM

**ARM的内核是基于RISC体系结构的**



**大多数ARM处理器都支持两种指令集**

**ARM指令集**

- 所有指令（机器码）都占用32bit存储空间
- 代码灵活度高、简化了解码复杂度
- 执行ARM指令集时PC值每次自增4 (32位对应4字节)

**Thumb指令集**

- 所有指令（机器码）都占用16bit存储空间
- 代码密度高、节省存储空间
- 执行Thumb指令集时PC值每次自增2



#### 编译原理

![image-20220728111406439](https://s2.loli.net/2022/07/28/iUBMNnPTrIbyCLD.png)

- 机器码（二进制）是处理器能够直接识别的语言，不同的机器码代表不同的运算指令，处理器能够识别哪些机器码是由处理器的硬件设计所决定的，不同的处理器机器码不同，所以机器码不可移植
- 汇编语言是机器码的符号化，汇编就是用一个符号来代替一条机器码，所以不同的处理器汇编也不一样，即汇编语言不可移植
- C语言在编译时我们可以使用不同的编译器将C源码编译成不同架构处理器的汇编，所以C语言可以移植







### ARM存储模型





#### ARM数据类型

ARM采用32位架构，基本数据类型有以下三种

| **Byte**     | **8bits**  |
| ------------ | ---------- |
| **Halfword** | **16bits** |
| **Word**     | **32bits** |

Word型数据在内存的起始地址必须是4的整数倍

Halfword型数据在内存的起始地址必须是2的整数倍

![image-20220728113359622](https://s2.loli.net/2022/07/28/FUKwpMCg5yzrYZR.png)



#### 字节序

![image-20220728113709990](https://s2.loli.net/2022/07/28/7bmfghDPystCHer.png)





#### ARM指令存储

-  **处理器处于ARM状态时**

  所有指令在内存的起始地址必须是4的整数倍

  PC的值也必须是4的整数倍，4的整数倍，其[1:0]位为0，由其[31:2]决定，[1:0]位未定义

- **处理器处于Thumb状态时**

  所有指令在内存的起始地址必须是2的整数倍

  PC值由其[31:1]决定，[0]位未定义

注：即指令本身是多少位在内存存储时就应该多少位对齐







### ARM工作模式

ARM共有8个基本的工作模式

- User 非特权模式，一般执行上层的应用程序时，ARM处于该模式
- FIQ 当一个高优先级中断产生后ARM进入这种模式
- IRQ 当一个低优先级中断产生后ARM进入这种模式
- SVC 当复位或执行软中断指令后ARM进入这种模式
- Abort 当产生存取异常时ARM进入这种模式
- Undef 当执行未定义的指令时ARM进入这种模式
- System 使用和User模式相同寄存器集的特权模式
- Monitor 为了安全而扩展出的用于执行安全监控代码的模式



#### 工作模式的理解

- 不同模式拥有不同权限
- 不同模式执行不同代码
- 不同模式完成不同的功能



#### ARM工作模式分类

user为非特权模式，其余模式均为特权模式

FIQ,IRQ,SVC,Abort,Undef属于异常模式，即当处理器遇到异常后会进入对应的模式









### ARM寄存器组织



#### 寄存器

- 概念

  ​	寄存器是处理器内部的存储器，没有地址

- 作用

  ​	一般用于暂时存放参与运算的数据和运算结果

- 分类

  ​	包括通用寄存器，专用寄存器，控制寄存器

C语言数据存储类型：

- auto
- extern
- static
- register



ARM处理器一共拥有**40个寄存器**

![image-20220731152616693](https://s2.loli.net/2022/07/31/VPpRKyWQxTHJw67.png)

在某个特定模式下只能使用当前模式下的寄存器，一个模式下特有的寄存器其他模式下不可使用



#### 专用寄存器

- R15(PC,Program Counter)

  程序计数器，用于存储当前取址指令的地址

- R14(LR,Link Register)

  链接寄存器，一般有以下两种用途：

  - 执行跳转指令(BL/BLX)时，LR会自动保存跳转指令下一条指令的地址，程序需要返回时将LR的值复制到PC，即可实现
  - 产生异常时，对应异常模式下的LR会自动保存被异常打断的指令的下一条指令的地址，异常处理结束后，将LR的值复制到PC，可实现程序返回

- R13(SP,Stack Pointer)

  栈指针，用于存储当前模式下的栈顶地址





#### CPSR寄存器

CPSR(Current Program Status Register)，当前程序状态寄存器

![image-20220731154857589](https://s2.loli.net/2022/07/31/hfbxCi4eI2HatF7.png)

CPSR寄存器分为四个域，[31:24]为条件域用F表示、[23:16]为状态域用S表示、[15:8]为预留域用X表示、[8:0]为控制域用C表示

- Bit[4:0]

  - [10000]User
  - [10001]FIQ
  - [10010]IRQ
  - [10011]SVC
  - [10111]Abort
  - [11011]Undef
  - [11111]System
  - [10110]Monitor

- Bit[5]

  - [0]ARM状态
  - [1]Thumb状态

- Bit[6]

  - [0]开启FIQ
  - [1]禁止FIQ

- Bit[7]

  - [0]开启IRQ
  - [1]禁止IRQ

- Bit[28]

  - 当运算器中进行加法运算时且产生符号位进位时该位自动置1，否则为0
  - 当运算器中进行减法运算时且产生符号位进位时该位自动置0，否则为1

- Bit[29]

  - 当运算器中进行加法运算时且产生进位时该位自动置1，否则为0
  - 当运算器中进行减法运算时且产生进位时该位自动置0，否则为1

- Bit[30]

  - 当运算器产生了0的结果该位自动置1，否则为0

- Bit[31]

  - 当运算器产生了负数的结果该位自动置1，否则为0

  

  

  

  

  

  

  

  











### SOC的概念（片上系统）

SOC(片上系统）指的是在单个芯片上集成一个完整的计算机系统，所谓完整的系统一般包括中央处理器（CPU)、存储器、以及外围电路等。

![image-20220725145956910](https://s2.loli.net/2022/07/25/wFjWsY1OdGSJNB7.png)





### ARM cortex处理器

![image-20220725150156733](https://s2.loli.net/2022/07/25/pD8cOqotbUsXfHx.png)







#### Cortex-M0结构框图

Cortex-M0微处理器主要包括**处理器内核**、**嵌套向量中断控制器(NVIC)**、**调试子系统**、**内部总线系统构成**。Cortex-M0微处理器通过精简的高性能总线(AHB-LITE)与外部进行通信。

![image-20220725150302331](https://s2.loli.net/2022/07/25/FkoSWXYetcMEifB.png)







#### Cortex-M0特性

- Thumb指令集，高效、高代码密度；
- 高性能，使用ARMv6-M的体系架构；
- 中断数量可配置（1~32个）,4级中断优先级，低中断切换时延，提供不可屏蔽中断（NMI)输入保障高可靠性系统；
- 门电路少，低功耗，处理器可在休眠状态下掉电以降低功耗，还可被WIC唤醒；
- 与Cortex-M1处理器兼容，向上兼容Cortex-M3和Cortex-M4处理器，可以很容易地升级到Cortex-M3。Cortex-M3和Cortex-M4移植到Cortex-M0也非常简单。
- 支持多种嵌入式操作系统，也被多种开发组件支持，包括MDK (ARM Keil 微控制器开发套件）、RVDS(ARMRealView开发组件）、IARC编译器等。



#### Cortex-M0工作模式

Cortex-M0有两种工作模式和两种工作状态

- **线程模式**(hread Mode)芯片复位后，即进入线程模式，执行用户程序
- **处理模式**(Handler Mode)当处理器发生了异常或者中断，则进入处理模式进行处理、处理完成后返回线程模式。
- **Thumb状态**：正常运行时处理器的状态
- **调试状态**：调试程序时处理器的状态





#### Cortex-M0寄存器组

Cortex-M0处理器内核有13个通用寄存器以及多个特殊寄存器，如图所示。

- 具体介绍如下：
  **R0-R12:通用寄存器**。其中RO-R7为低端寄存器，可作为16位或32位指令操作数，R8-R12为高端寄存器，只能用作32位操作数
- **R13:堆栈指针SP**,Cortex-M0在不同物理位置上存在两个栈指针，**主栈指针MSP, 进程栈指针PSP**。**在处理模式下，只能使用主堆栈**，**在线程模式下，可以使用主堆栈也可以使用进程堆栈**，这主要是由CONTROL寄存器控制完成。系统上电的默认栈指针是MSP 
- **R14:连接寄存器**（LR),用于存储子程序或者函数调用的返回地址
- **R15:程序计数器**（PC),存储下一条将要执行的指令的地址。
- **xPSR：组合程序状态寄存器**，该寄存器由三个程序状态寄存器组成
  - 应用PSR（APSR）：包含前一条指令执行后的条件标志
  - 中断PSR（IPSR）：包含当前ISR的异常编号
  - 执行PSR（ EPSR）：包含Thumb状态位
- **PRIMSK** ：中断屏蔽特殊寄存器。
- **CONTROL**：控制寄存器控制处理器处于线程模式是，使用哪个堆栈＝0， 使用MSP ＝1，使用PSP 处理器模式时，固定使用MSP

 ![image-20220725151113430](https://s2.loli.net/2022/07/25/ZGIw42ipVgcqNuf.png)

![image-20220725151701869](https://s2.loli.net/2022/07/25/laFsumXRGLwrgQ9.png)





#### Cortex-M0异常和中断

Cortex-M0处理器最多支持**32个外部中断**（通常称为IRQ）和一**个不可屏蔽中断**（NMl），另外Cortex-M0还支持许多系统异常(Reset、HardFault、SVCall、PendSV、SysTick),它们主要用于操作系统和错误处理



#### Cortex-M0指令集

ARM处理器支持两种指令集：ARM和Thumb。

EPSR寄存器的T标志位负责指令集的切换， Cortex-M0只支持Thumb指令

- **ARM指令集**
  - 32位精简指令集；
  - 指令长度固定；
  - 降低编码数量产生的耗费，减轻解码和流水线的负担；
- **Thumb指令集**
  - Thumb指令集是ARM指令集的一个子集；
  - 指令宽度16位；
  - 与32位指令集相比，大大节省了系统的存储空间；
  - Thumb指令集不完整， 所以必须配合ARM指令集一同使用。



