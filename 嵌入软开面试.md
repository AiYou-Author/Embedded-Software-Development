# 第一章进程线程



## 1.1 进程线程的基本概念



### 1.1.1 什么是进程，线程，彼此有什么区别



**PCB，程序段，数据段**三部分构成了进程实体

进程就是进程实体的运行过程，是系统进行**资源分配**和**调度**的一个独立单位



线程为**程序执行流的最小单位**

线程为CPU分配时间资源的基本单元



**区别**：

一个进程可以拥有多个线程。同一进程的不同线程间共享进程的资源。

通信：进程间通信IPC（管道，信号量，共享内存，消息队列），线程间直接使用进程数据段进行通信

调度和切换：同一进程间切换系统开销很小



### 1.1.2 多进程、多线程的优缺点



多进程

优点：多进程使用独立的地址以及资源，一个进程结束不会影响其他进程

缺点：多进程进行任务切换，会大量浪费CPU资源



多线程

优点：任务切换效率高；所有线程共享内存和变量；多线程间通信较为容易

缺点：一个线程崩溃影响整个进程；线程之间的同步和加锁控制比较麻烦；

|          | 多进程                                         | 多线程                                                       |
| :------- | ---------------------------------------------- | ------------------------------------------------------------ |
| 资源     | 多进程使用独立的地址以及资源，进程之间互不影响 | 多线程共用地址以及资源，同一进程中的一个线程死了会影响其他线程 |
| 性能     | 多进程更强，享有独立资源                       | 多线程共用资源                                               |
| 花销     | 进程切换效率低，耗费大量资源                   | 线程切效率高                                                 |
| 通信     | 进程间通信需跨越进程边界                       | 线程间通信使用共享内存和变量                                 |
| 控制逻辑 | 多进程更为复杂                                 | 多线程控制逻辑更为容易，但是需要线程同步和加锁控制           |
| 数量     | 进程数量由CPU决定                              | 线程数量由进程的空间资源和线程本身栈大小决定                 |



### 1.1.3 什么时候用进程，什么时候用线程

需要频繁快速切换的时候选择线程

需要安全稳定时选择进程







### 1.1.4多进程、多线程同步的方法

进程间通信：

- 管道、无名管道
- 消息队列
- 信号量
- 共享内存
- 信号
- socket

线程间通信：

- 信号量
- 读写锁
- 条件变量
- 互斥锁
- 自旋锁

#### 互斥锁与信号量的区别

互斥锁用于线程互斥，信号量用于线程同步以及进程同步









### 1.1.5 进程的空间模型

![img](https://s2.loli.net/2022/06/23/36YvmCrwjh5SQbi.png)

32位系统，运行程序创建进程时，为其分配4G的虚拟地址空间，3G为用户空间，1G为内核空间

栈：由编译器自动分配和释放，存放函数的参数值，局部变量等

堆：一般由程序员分配和释放，若不释放会造成内存泄漏，程序结束可能又操作系统收回。

全局区：全局变量和静态变量放在一起，分为未初始化（.bss）和初始化（.data）的区域

文字常量区：常量字符串，程序结束后由系统释放（.rodata）

程序代码区：存放函数的二进制代码（.txt）



### 1.1.6 一个进程可以创建多少个线程，和什么有关



一个进程的可用虚拟空间为2G，默认情况下，线程的栈的大小为1MB，理论上可以创建2048个线程。

一个进程可以创建的线程个数由虚拟空间大小以及线程栈的大小决定。







### 1.1.7 进程线程的状态转换图，什么时候阻塞，什么时候就绪？

创建态：进程正在被创建，初识PCB，分配资源

就绪态：进程已具备除CPU外的所有资源

运行态：占用CPU，在处理机上运行

阻塞态：由于等待某些资源而导致进程暂停运行

结束态：撤销进程，撤销PCB，撤销资源

挂起态：由于某些资源得不到，将进程挂入外存

![image-20220530154124719](https://s2.loli.net/2022/06/23/DVRkhzH2lP9ox5I.png)







### 1.1.8 父进程，子进程的关系和区别

子进程继承父进程：

   ○用户号UIDs和用户组号GIDs

   ○环境Environment

   ○堆栈

   ○共享内存

   ○打开文件的描述符

   ○执行时关闭（Close-on-exec）标志

   ○信号（Signal）控制设定

   ○进程组号

   ○当前工作目录

   ○根目录

   ○文件方式创建屏蔽字

   ○资源限制

   ○控制终端

子进程独有的：

   ○进程号PID

   ○不同的父进程号

   ○自己的文件描述符和目录流的拷贝

   ○子进程不继承父进程的进程正文（text），数据和其他锁定内存（memory locks）

   ○不继承异步输入和输出 



父进程：

子进程：由父进程使用fork()系统调用创建。

**联系：**

创建子进程作为父进程的副本；子进程继承父进程大部分的属性。

子进程与父进程拥有相同内容的代码段、数据段和用户堆栈，目录。

**区别**：

子进程拥有自己的进程号PID，拥有独立的地址空间，自己的文件描述符和目录流的拷贝





### 1.1.9 什么是进程上下文，中断上下文

**进程上下文**：

​	一个进程在执行的时候，CPU中的所有寄存器中的值，进程的状态以及堆栈中的内容，当需要切换到另外一个进程时，需要保存当前进程的所有状态，即保存当前进程的进程上下文，以便再次运行此进程时，能够恢复切换前的状态。

​	切换到内核态后执行的程序，即运行在内核空间的部分。



**中断上下文：**

​	由硬件通过触发信号，导致内核调用中断处理程序，进入内核空间。硬件的一些变量和参数也要传递给内核，内核通过这些参数进行中断处理，中断上下文可以理解为硬件传递过来的这些参数和内核需要保存的一些环境。

​	当用户进程想要访问系统资源，必须通过系统调用或者中断切换到内核态，由内核执行。















