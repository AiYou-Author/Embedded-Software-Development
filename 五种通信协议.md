## UART通信



### 串口通信简介

​	Universal Asynchron ou Receiver Transmitter ，即**通用异步收发器**，是一种通用的**串行、异步通信总线**,该总线有两条数据线，可以实现全双工的发送和接收在嵌入式系统中常用于主机与辅助设备之间的通信



### 波特率

​	波特率用于描述UART通信时的通信速度,其单位为bps (bit per second)即每秒钟传送的bit的数量



### UART帧格式

![image-20220726113456305](https://s2.loli.net/2022/07/26/qfs1HoTxGM2CbYR.png)

可以使用0或者1bit的校验位，校验位可以是奇校验或者偶检验。

奇校验：数据加校验位中1的个数为奇数；

偶校验：数据加校验位中1的个数为偶数。



### UART硬件连接

![image-20220726113442443](https://s2.loli.net/2022/07/26/T4E7jmkCDs6nB8z.png)



### UART存在的问题

**电气接口不统一**

  UART只是对信号的时序进行了定义，而未定义接口的电气特性；

  UART通信时一般直接使用处理器使用的电平，即**TTL电平**，但不同的处理器使用的电平存在差异， 所以不同的处理器使用UART，通信时一般不能直接相连；

  UART没有规定不同器件连接时连接器的标准， 所以不同器件之间通过UART通信时连接很不方便;





## RS232协议

​	RS232协议是在1970年由美国电子工业协会(EIA)联合贝尔系统、调制解调器厂家、计算机终端生产厂家共同制定的用于串行通讯的标准； 

​	该标准规定采用一个标准的连接器，标准中对连接器的每个引脚的作用加以规定，还对信号的电平加以规定；

![image-20220726113841246](https://s2.loli.net/2022/07/26/vuSJ9copTaymID4.png)

### 接口

​	该标准规定采用一个25引脚的DB-25连接器，标准中对连接器的每个引脚的信号内容加以规定，还对各种信号的电平加以规定； 后来IBM的PC机将RS232简化成了DB-9连接器，后来成为事实标准； **现在工业控制的RS-232接口一般只使用RXD、TXD、GND三条线;**





### 信号

​	该标准规定**逻辑“1”的电平为-5v到-15v**，**逻辑“0”的电平为+5v 到+15v**，选用该电气标准的目的在于提高抗干扰能力，增大通信距离，**其传送距离一般可达15m；**





### 电平转换

虽然很多处理器中都会集成UART控制器，但处理器产生的信号一般都是TTL信号并不是符合RS232标准的信号，所以一般我们还需要在处理器外部，去添加电路对信号的电平进行转换；

![image-20220726114144216](https://s2.loli.net/2022/07/26/8CUHV7Rorz29yaj.png)



### RS232 存在的问题

- 接口的信号电平值较高，易损坏接口电路的芯片，又因为与TTL电平不兼容，所以需要使用电平转换芯片才能与TTL电路连接
- 通信速度较低
- 易产生共模干扰，抗噪声干扰性弱
- 传输距离较短（15m）









## RS485协议

​	该标准由电信行业协会和电子工业联盟定义；使用该标准的通信网络能在远距离条件下以及电子噪声大的环境下有效传输信号； 该标准允许连接多个收发器，即具有多站能力，这样可以利用单一的RS485接口方便地建立起一个设备网络

![image-20220726114605517](https://s2.loli.net/2022/07/26/TgkG4i15AJtP8Im.png)





### 信号

​	RS485标准规定采用差分信号进行数据传输，**两线间的电压差为+2v到+6v表示逻辑“1”**，**两线间的电压差为-2v到-6v表示逻辑“0”**；**使用差分信号能有效地减少噪声信号的干扰**，延长通信距离，RS485的通信距离可以达到1500m；RS485接口信号的电平比RS232降低了，所以不易损坏接口电路的芯片，且该电平与TTL电平兼容，可方便地与TTL电路连接





### 接口

​	RS485采用两线制，这种接线方式为总线式拓扑结构，在同一总线上可以同时存在多个节点；

 	因为采用两线制，**数据的发送和接收都要使用这对差分信号线，发送和接收不能同时进行**，所以只能采用**半双工**的方式工作，编程时也需要加以处理





### 电平转换

​	虽然很多处理器中都会集成UART控制器，但处理器产生的信号一般都是TTL信号并不是符合RS485标准的信号，所以一般我们还需要在处理器外部去添加电路将TTL信号转换成差分信号；

![image-20220726115355367](https://s2.loli.net/2022/07/26/uEZJCs7igGUolpy.png)





### RS485的优势

- 接口的信号电平值较低，不易损坏接口电路的芯片，且与TTL电平兼容，可方便地与TTL电路连接
- 通信速度快
- 抗噪声干扰性强
- 传输距离较远（1500m）
- 可实现多节点组网











## IIC总线



### IIC总线介绍 



​	IIC总线是Philips公司在八十年代初推出的一种串行、半双工总线主要用于近距离、低速的芯片之间的通信。

​	llC总线有两根双向的信号线，**一根数据线SDA用于收发数据**，**一根时钟线SCL用于通信双方时钟的同步**，IIC总线硬件结构简单，成本较低，因此在各个领域得到了广泛的应用

![image-20220725215221950](https://s2.loli.net/2022/07/25/9kUNBC1pseatH5v.png)

​	IIC总线是一种多主机总线，连接在**IIC总线上的器件分为主机和从机**，主机有权发起和结束一次通信，而从机只能被主机呼叫；当总线上有多个主机同时启用总线时，IIC也具备冲突检测和仲裁的功能来防止错误产生；

​	**每个连接到IIC总线上的器件都有一个唯一的地址（7bit）**，且每个器件都可以作为主机也可以作为从机（同一时刻只能有一个主机），总线上的器件增加和删除不影响其他器件正常工作；IIC总线在通信时总线上发送数据的器件为发送器，接收数据的器件为接收器；



**数据帧格式**

`开始位 | 7bit从机地址 | 1bit读写方向位（0写，1读） | 1bit应答 | 8bit数据1 | 1bit应答1| ...  | 8bit数据N |1bit非应答N | 停止位 。`



### IIC总线的通信方式

1．主机发送起始信号启用总线

2．主机发送一个字节数据指明从机地址和后续字节的传送方向

3．被寻址的从机发送应答信号回应主机

4．发送器发送一个字节数据

5．接收器发送应答信号回应发送器．．（循环步骤4、5）

n.   通信完成后主机发送停止信号释放总线





### IIC总线寻址方式

​	IIC总线上传送的数据是广义的，既包括地址，又包括真正的数据

​	主机在发送起始信号后必须先发送一个字节的数据，**该数据的高7位为从机地址，最低位表示后续字节的传送方向，'0'表示主机发送数据，'1'表示主机接收数据**；总线上所有的从机接收到该字节数据后都将这7位地址与自己的地址进行比较，如果相同，则认为自己被主机寻址，然后再根据第8位将自己定为发送器或接收器

![image-20220725214722875](https://s2.loli.net/2022/07/25/H2XgyCuGF8DM3q1.png)





### 起始信号与结束信号

- **SCL为高电平时, SDA由高变低表示起始信号**
- **SCL为高电平时, SDA由低变高表示停止信号**
- 起始信号和停止信号都是由主机发出,起始信号产生后总线处于占用状态，停止信号产生后总线处于空闲状态

![image-20220725221448778](https://s2.loli.net/2022/07/25/PgLsFdi7YScK6nR.png)



### 字节传送与应答

​	IIC总线通信时，每个字节为**8位长度**， 数据传送时， **先传送最高位，后传送低位**，发送器发送完一个字节数据后，接收器必须发送1位应答位来回应发送器，即**一帧共有9位**

![image-20220725215844275](https://s2.loli.net/2022/07/25/xOGcRLvboJuT25V.png)

 



### 同步信号

​	llC总线在进行数据传送时，**时钟线SCL为低电平期间，发送器向数据线上发送一位数据，在此期间数据线上的信号允许发生变化**，**时钟线SCL为高电平期间，接收器从数据线上读取一位数据**，在此期间数据线上的信号不允许发生变化，必须保持稳定

![image-20220725220333181](https://s2.loli.net/2022/07/25/8hMjkNuGXlFSUaH.png)





### 典型IIC时序

**主机向从机发送数据**

![image-20220725221111158](https://s2.loli.net/2022/07/25/K4qDTHUV7XSw2F5.png)

**从机给主机发送数据**

![image-20220725221132916](https://s2.loli.net/2022/07/25/dO6szHbMqk9FcXa.png)

**主机先向从机发送数据，然后从机再向主机发送数据**

![image-20220725221913162](https://s2.loli.net/2022/07/25/khiWI8A9ZjSnKJE.png)

注：阴影部分表示数据由主机向从机传送，无阴影部分则表示数据由从机向主机传送；A表示应答，A非表示非应答，S表示起始信号，P表示终止信号

















## SPI通信



### SPI简介

​	SPI(Serial Peripheral Interface)是串行外设接口的缩写，**SPI是一种高速的、全双工、同步的串行通信总线**；**SPI采用主从方式工作，一般有一个主设备和一个或多个从设备**； SPI需要至少4根线，分别是**MISO（主设备输入从设备输出）**、**MOSI（主设备输出从设备输入）**、**SCLK（时钟）**、**CS（片选）**，SPI使用引脚较少且布线方便，所以越来越多的芯片集成了这种通信协议；

![image-20220726120505020](https://s2.loli.net/2022/07/26/FtfKHQD6E7qAzlx.png)



### 寻址方式

​	当主设备要和某个从设备进行通信时，主设备需要先向对应从设备的片选线上发送使能信号（高电平或者低电平，根据从机而定）表示选中该从设备

![image-20220726203423486](https://s2.loli.net/2022/07/27/FLA6zJn3aIm28dq.png)





### 通信过程

​	SPI总线在进行数据传送时，**先传送高位，后传送低位**；**数据线为高电平表示逻辑‘1’，低电平表示逻辑‘0’；一个字节传送完成后无需应答，即可开始下一个字节的传送**； SPI总线采用**同步方式**工作，**时钟线在上升沿或下降沿时发送器向数据线上发送数据，在紧接着的下降沿或上升沿时接收器从数据线上读取数据**，完成一位数据传送，八个时钟周期即可完成一个字节数据的传送;

![image-20220726204228621](https://s2.loli.net/2022/07/27/3RYWQBzEIFxL9Ng.png)



### 极性和相位

SPI总线有四种不同的工作模式，取决于极性(CPOL)和相位(CPHL)这两个因素

-  CPOL表示SCLK空闲时的状态
  -  CPOL=0，空闲时SCLK为低电平
  -  CPOL=1，空闲时SCLK为高电平

-  CPHA表示采样时刻
  -  CPHA=0，每个周期的第一个时钟沿采样
  -  CPHA=1，每个周期的第二个时钟沿采样



- CPOL=0,CPHA=0; 下降沿写数据，上升沿读数据

  ![image-20220726205510010](https://s2.loli.net/2022/07/27/YlGaTsqOpIeo5g4.png)

- CPOL=0,CPHA=1;上升沿写数据，下降沿读数据

  ![image-20220726205642332](https://s2.loli.net/2022/07/27/ue7DTBi8ytFxJ93.png)

- CPOL=1,CPHA=0; 上升沿写数据，下降沿读数据

  ![image-20220726205713695](https://s2.loli.net/2022/07/27/caUdG73i6Eopmxv.png)

- CPOL=1,CPHA=1;下降沿写数据，上升沿读数据

  ![image-20220726205704202](https://s2.loli.net/2022/07/27/72UQfKAa9lvMoqE.png)

需要说明的是，对于一个特定的从设备来说，一般在出厂时就会将其设计为某种特定的工作模式；我们在使用该设备时就必须保证主设备的工作模式和该从设备保持一致，否则是无法进行通信的；所以一般我们需要对主设备的CPOL和CPHA进行配置；



### IIC和SPI的异同

**相同点**

  1.均采用串行、同步的方式

  2.均采用TTL电平，传输距离和应用场景类似

  3.均采用主从方式工作

**不同点**

  1.IIC为半双工，SPI为全双工

  2.IIC有应答机制，SPI无应答机制

  3.IIC通过向总线广播从机地址来寻址，SPI通过向对应从机发送使能信号来寻址

  4.IIC的时钟极性和时钟相位固定，SPI的时钟极性和时钟相位可调

